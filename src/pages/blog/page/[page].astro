---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";

const PAGE_SIZE = 6;
const allPosts = (await getCollection('blog')).sort(
	(a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
const totalPages = Math.max(1, Math.ceil(allPosts.length / PAGE_SIZE));

export async function getStaticPaths() {
	const posts = (await getCollection('blog')).sort(
		(a, b) => b.data.date.valueOf() - a.data.date.valueOf()
	);
	const pageSize = 6;
	const pages = Math.max(1, Math.ceil(posts.length / pageSize));

	return Array.from({ length: pages - 1 }, (_, idx) => {
		const page = idx + 2;
		const start = (page - 1) * pageSize;
		const end = start + pageSize;
		return {
			params: { page: String(page) },
			props: {
				page,
				posts: posts.slice(start, end),
				totalPages: pages,
			},
		};
	});
}

const { page, posts } = Astro.props as {
	page: number;
	posts: typeof allPosts;
	totalPages: number;
};
---

<Layout title={`Blog - Página ${page} | Lenin AGC`} description="Blog posts paginados">
	<div class="container space-y-10 pt-24 pb-12">
		<section class="space-y-4">
			<h1 class="text-4xl font-bold tracking-tight lg:text-5xl text-livekit-cyan">My space...</h1>
			<p class="text-xl text-muted-foreground">
				This is my blog and agenda. I write about GNU/Linux, programming, code snippets, tools, tutorials.
			</p>
		</section>

		<div class="grid gap-4 md:gap-5 sm:grid-cols-2 lg:grid-cols-3">
			{posts.map((post) => (
				<a href={`/blog/${post.id}`} class="bento-card group relative rounded-2xl backdrop-blur-md overflow-hidden transition-all duration-500">
					<div class="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-livekit-cyan/0 to-transparent group-hover:via-livekit-cyan/60 transition-all duration-700"></div>
					<div class="p-6 md:p-8 flex flex-col justify-between h-full min-h-[180px]">
						<div class="flex items-start justify-between mb-6">
							<Badge variant="outline" class="border-border text-muted-foreground text-[10px] uppercase tracking-widest px-2.5 py-0.5 group-hover:border-livekit-cyan/30 group-hover:text-livekit-cyan transition-all duration-500">
								{post.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
							</Badge>
							<span class="text-muted-foreground/50 text-lg group-hover:text-livekit-cyan/70 group-hover:translate-x-1 transition-all duration-300">→</span>
						</div>
						<div class="space-y-2 mt-auto">
							<h3 class="text-lg font-bold tracking-tight text-foreground group-hover:text-livekit-cyan transition-colors duration-300 line-clamp-2">
								{post.data.title}
							</h3>
							{post.data.description && (
								<p class="text-sm text-muted-foreground/70 line-clamp-2 leading-relaxed">
									{post.data.description}
								</p>
							)}
							<div class="flex flex-wrap gap-2">
								{post.data.tags?.slice(0, 3).map(tag => (
									<span class="text-[10px] uppercase tracking-wider text-muted-foreground/60">#{tag}</span>
								))}
							</div>
						</div>
					</div>
				</a>
			))}
		</div>

		<nav class="flex items-center justify-center gap-2 pt-6" aria-label="Blog pagination">
			<a
				href={page === 2 ? '/blog' : `/blog/page/${page - 1}`}
				class:list={[
					'inline-flex h-10 items-center justify-center rounded-md border px-4 text-sm transition-colors',
					'border-border text-muted-foreground hover:border-livekit-blue/40 hover:text-livekit-cyan',
				]}
			>
				Anterior
			</a>

			{Array.from({ length: totalPages }, (_, i) => i + 1).map((p) => (
				<a
					href={p === 1 ? '/blog' : `/blog/page/${p}`}
					aria-current={p === page ? 'page' : undefined}
					class:list={[
						'inline-flex h-10 min-w-10 items-center justify-center rounded-md border px-3 text-sm transition-colors',
						p === page
							? 'border-livekit-blue bg-livekit-blue/15 text-livekit-cyan'
							: 'border-border text-muted-foreground hover:border-livekit-blue/40 hover:text-livekit-cyan',
					]}
				>
					{p}
				</a>
			))}

			<a
				href={page === totalPages ? '#' : `/blog/page/${page + 1}`}
				aria-disabled={page === totalPages}
				class:list={[
					'inline-flex h-10 items-center justify-center rounded-md border px-4 text-sm transition-colors',
					page === totalPages
						? 'pointer-events-none border-border/40 text-muted-foreground/50'
						: 'border-border text-muted-foreground hover:border-livekit-blue/40 hover:text-livekit-cyan',
				]}
			>
				Siguiente
			</a>
		</nav>
	</div>
</Layout>
