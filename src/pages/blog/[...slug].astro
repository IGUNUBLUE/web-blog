---
import { getCollection, render } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import { Badge } from "@/components/ui/badge";

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.id }, props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const formattedDate = post.data.date.toLocaleDateString('en-US', {
	year: 'numeric',
	month: 'long',
	day: 'numeric'
});

// Reading time estimate
const wordsPerMinute = 200;
// rough estimate from title length as proxy (content not easily accessible as raw text)
const readingTime = Math.max(3, Math.ceil((post.data.title.length * 50) / wordsPerMinute));

// Get all posts for prev/next navigation
const allPosts = (await getCollection('blog')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const currentIndex = allPosts.findIndex(p => p.id === post.id);
const prevPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
---

<Layout title={`${post.data.title} | Lenin AGC`} description={post.data.description || post.data.title}>
	<article class="pt-24 pb-16">
		{/* ── Hero header ── */}
		<header class="relative overflow-hidden">
			{/* Background glow */}
			<div class="absolute inset-0 -z-10 pointer-events-none">
				<div class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-livekit-blue/8 blur-[120px] rounded-full"></div>
			</div>

			<div class="container max-w-4xl mx-auto px-6 py-12 md:py-16 space-y-6">
				{/* Categories */}
				<div class="flex flex-wrap justify-center gap-2">
					{post.data.categories?.map(cat => (
						<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium tracking-wide uppercase bg-livekit-blue/10 text-livekit-cyan border border-livekit-cyan/15">
							{cat}
						</span>
					))}
				</div>

				{/* Title */}
				<h1 class="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight text-center leading-[1.15] text-balance text-foreground">
					{post.data.title}
				</h1>

				{/* Description */}
				{post.data.description && (
					<p class="text-center text-base md:text-lg text-muted-foreground max-w-2xl mx-auto leading-relaxed">
						{post.data.description}
					</p>
				)}

				{/* Meta row */}
				<div class="flex items-center justify-center gap-3 text-sm text-muted-foreground flex-wrap">
					<div class="flex items-center gap-2">
						<div class="w-7 h-7 rounded-full bg-gradient-to-br from-livekit-blue to-livekit-cyan flex items-center justify-center text-[10px] font-bold text-white">
							LA
						</div>
						<span class="font-medium text-foreground/80">{post.data.author}</span>
					</div>
					<span class="text-border">•</span>
					<time datetime={post.data.date.toISOString()}>{formattedDate}</time>
					<span class="text-border">•</span>
					<span>{readingTime} min read</span>
				</div>

				{/* Cover image */}
				{post.data.cover && (
					<div class="pt-4">
						<img 
							src={post.data.cover} 
							alt={post.data.title}
							class="w-full rounded-xl border border-border/40 shadow-lg shadow-black/10 max-h-[420px] object-cover"
							loading="eager"
						/>
					</div>
				)}
			</div>

			{/* Divider */}
			<div class="relative h-px max-w-4xl mx-auto">
				<div class="absolute inset-0 bg-gradient-to-r from-transparent via-livekit-cyan/40 to-transparent"></div>
			</div>
		</header>

		{/* ── Article body ── */}
		<div class="container max-w-4xl mx-auto px-6 py-10 md:py-14">
			<div class="article-prose prose prose-invert prose-livekit max-w-none
				prose-headings:scroll-mt-24
				prose-a:transition-colors
				prose-code:before:content-none prose-code:after:content-none
				prose-pre:overflow-x-auto
				prose-img:mx-auto">
				<Content />
			</div>
		</div>

		{/* ── Footer divider ── */}
		<div class="relative h-px max-w-4xl mx-auto">
			<div class="absolute inset-0 bg-gradient-to-r from-transparent via-livekit-cyan/40 to-transparent"></div>
		</div>

		{/* ── Tags ── */}
		{post.data.tags && post.data.tags.length > 0 && (
			<div class="container max-w-4xl mx-auto px-6 pt-8 pb-4">
				<div class="flex flex-wrap gap-2 justify-center">
					{post.data.tags.map(tag => (
						<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-mono border border-border/60 text-muted-foreground hover:border-livekit-cyan/40 hover:text-livekit-cyan transition-all duration-300 cursor-default">
							#{tag}
						</span>
					))}
				</div>
			</div>
		)}

		{/* ── Prev/Next navigation ── */}
		<div class="container max-w-4xl mx-auto px-6 pt-8 pb-4">
			<nav class="grid grid-cols-1 sm:grid-cols-2 gap-4">
				{prevPost ? (
					<a href={`/blog/${prevPost.id}`} class="group bento-card rounded-xl p-5 transition-all duration-300 hover:scale-[1.01] relative overflow-hidden">
						<div class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-livekit-cyan/0 group-hover:via-livekit-cyan/60 to-transparent transition-all duration-500"></div>
						<span class="text-xs uppercase tracking-wider text-muted-foreground mb-2 block">← Previous</span>
						<span class="text-sm font-medium text-foreground/80 group-hover:text-livekit-cyan transition-colors line-clamp-2">{prevPost.data.title}</span>
					</a>
				) : <div />}
				{nextPost ? (
					<a href={`/blog/${nextPost.id}`} class="group bento-card rounded-xl p-5 transition-all duration-300 hover:scale-[1.01] relative overflow-hidden text-right sm:col-start-2">
						<div class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-livekit-cyan/0 group-hover:via-livekit-cyan/60 to-transparent transition-all duration-500"></div>
						<span class="text-xs uppercase tracking-wider text-muted-foreground mb-2 block">Next →</span>
						<span class="text-sm font-medium text-foreground/80 group-hover:text-livekit-cyan transition-colors line-clamp-2">{nextPost.data.title}</span>
					</a>
				) : null}
			</nav>
		</div>

		{/* ── Back to blog ── */}
		<div class="container max-w-4xl mx-auto px-6 pt-6 pb-8 flex justify-center">
			<a href="/blog" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-medium border border-border/60 text-muted-foreground hover:text-livekit-cyan hover:border-livekit-cyan/40 transition-all duration-300">
				<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
				</svg>
				All Posts
			</a>
		</div>
	</article>
</Layout>

<style is:global>
	@reference "../../styles/global.css";

	/* ── Custom prose theme for LiveKit aesthetic ── */

	/* Headings */
	.article-prose :where(h1, h2, h3, h4):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		color: var(--color-foreground);
		font-weight: 700;
		letter-spacing: -0.02em;
	}

	.article-prose :where(h2):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		margin-top: 3rem;
		margin-bottom: 1.25rem;
		padding-bottom: 0.75rem;
		border-bottom: 1px solid var(--glass-border);
		font-size: 1.5rem;
	}

	.article-prose :where(h3):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		margin-top: 2rem;
		margin-bottom: 0.75rem;
		font-size: 1.25rem;
		color: var(--color-livekit-cyan);
	}

	.article-prose :where(h4):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		margin-top: 1.5rem;
		margin-bottom: 0.5rem;
		font-size: 1.1rem;
		color: var(--color-livekit-cyan);
	}

	/* Paragraphs */
	.article-prose :where(p):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		line-height: 1.85;
		margin-bottom: 1.5rem;
		color: var(--color-foreground);
		opacity: 0.88;
	}

	/* Links */
	.article-prose :where(a):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		color: var(--color-livekit-cyan);
		text-decoration: none;
		font-weight: 500;
		border-bottom: 1px solid transparent;
		transition: border-color 0.2s ease, color 0.2s ease;
	}

	.article-prose :where(a):not(:where([class~="not-prose"], [class~="not-prose"] *)):hover {
		border-bottom-color: var(--color-livekit-cyan);
	}

	/* Lists */
	.article-prose :where(ul, ol):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		margin-bottom: 1.5rem;
		padding-left: 1.25rem;
	}

	.article-prose :where(li):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		margin-bottom: 0.5rem;
		line-height: 1.75;
		color: var(--color-foreground);
		opacity: 0.88;
	}

	.article-prose :where(li)::marker {
		color: var(--color-livekit-cyan);
	}

	/* Inline code */
	.article-prose :where(code):not(:where(pre *, [class~="not-prose"], [class~="not-prose"] *)) {
		background: var(--glass-bg);
		border: 1px solid var(--glass-border);
		padding: 0.15em 0.4em;
		border-radius: 0.375rem;
		font-size: 0.875em;
		font-weight: 500;
		color: var(--color-livekit-cyan);
	}

	/* Code blocks */
	.article-prose :where(pre):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		background: oklch(0.05 0.01 240) !important;
		border: 1px solid var(--glass-border);
		border-radius: 0.75rem;
		padding: 1.25rem 1.5rem;
		margin-bottom: 1.75rem;
		font-size: 0.85rem;
		line-height: 1.7;
		overflow-x: auto;
	}

	.light .article-prose :where(pre):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		background: oklch(0.96 0.005 240) !important;
		border-color: var(--glass-border);
	}

	.article-prose :where(pre code):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		background: transparent !important;
		border: none !important;
		padding: 0 !important;
		font-size: inherit;
		color: inherit;
	}

	/* Images */
	.article-prose :where(img):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		border-radius: 0.75rem;
		border: 1px solid var(--glass-border);
		box-shadow: 0 4px 30px rgba(0, 0, 0, 0.15);
		margin-top: 1.5rem;
		margin-bottom: 1.5rem;
		transition: transform 0.3s ease, box-shadow 0.3s ease;
	}

	.article-prose :where(img):not(:where([class~="not-prose"], [class~="not-prose"] *)):hover {
		transform: scale(1.01);
		box-shadow: 0 8px 40px rgba(0, 0, 0, 0.25), 0 0 30px -8px var(--glass-glow);
	}

	/* Blockquotes */
	.article-prose :where(blockquote):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		border-left: 3px solid var(--color-livekit-cyan);
		background: var(--glass-bg);
		border-radius: 0 0.75rem 0.75rem 0;
		padding: 1rem 1.5rem;
		margin: 1.5rem 0;
		font-style: italic;
	}

	.article-prose :where(blockquote p):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		margin-bottom: 0;
		opacity: 0.85;
	}

	/* Horizontal rules */
	.article-prose :where(hr):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		border: none;
		height: 1px;
		background: linear-gradient(to right, transparent, var(--glass-border), transparent);
		margin: 2.5rem 0;
	}

	/* Strong */
	.article-prose :where(strong):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		color: var(--color-foreground);
		font-weight: 700;
	}

	/* Tables */
	.article-prose :where(table):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		width: 100%;
		border-collapse: collapse;
		margin: 1.5rem 0;
	}

	.article-prose :where(th):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		background: var(--glass-bg);
		border: 1px solid var(--glass-border);
		padding: 0.75rem 1rem;
		text-align: left;
		font-weight: 600;
		font-size: 0.875rem;
		color: var(--color-livekit-cyan);
	}

	.article-prose :where(td):not(:where([class~="not-prose"], [class~="not-prose"] *)) {
		border: 1px solid var(--glass-border);
		padding: 0.75rem 1rem;
		font-size: 0.875rem;
	}

	/* First paragraph after the first h1 or at start → lead paragraph */
	.article-prose > p:first-child,
	.article-prose > h1 + p {
		font-size: 1.125rem !important;
		line-height: 1.75 !important;
		opacity: 0.92 !important;
	}
</style>
